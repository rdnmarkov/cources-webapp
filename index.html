<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Courses</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Retro font -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">

    <link href="/css/index.css" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>

<body>

<!-- SIDEBAR -->
<div class="sidebar">
    <h5 class="mb-3" style="color:#ff4df7; font-family:'Press Start 2P'; font-size:14px;">–ö–ê–¢–ï–ì–û–†–ò–ò</h5>
    <div id="categoryList"></div>
</div>

<!-- MAIN CONTENT -->
<div class="content">
    <h2 class="mb-4" style="font-family: 'Press Start 2P'; color:#ff76ff;">–ö–£–†–°–´. –í–∏—Å–∫–∏ —Å –∫–æ–¥–æ–º</h2>

    <div class="mb-4 d-flex">
        <input id="searchInput"
               type="text"
               class="form-control form-control-lg"
               style="background:rgba(30,0,60,0.6); border:2px solid #8a2eff; color:#e7dbff;"
               placeholder="üîé –ü–æ–∏—Å–∫ –ø–æ –∫—É—Ä—Å–∞–º –∏ —É—Ä–æ–∫–∞–º...">
        <button id="searchButton" class="btn btn-primary ms-2" style="min-width:120px;">üîç –ü–æ–∏—Å–∫</button>
    </div>

    <div id="coursesContainer" class="row g-4"></div>

    <nav>
        <ul id="pagination" class="pagination mt-4"></ul>
    </nav>
</div>


<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const urlParams = new URLSearchParams(window.location.search);
    const chatId = urlParams.get("chatId");

    const API = {
        categories: "https://cors-anywhere.herokuapp.com/http://109.73.207.225:8080/api/categories",
        courses: "https://cors-anywhere.herokuapp.com/http://109.73.207.225:8080/api/courses",
        search: "https://cors-anywhere.herokuapp.com/http://109.73.207.225:8080/api/search"
    };

    let currentPage = 0;
    let totalPages = 0;

    loadCategories();
    loadCourses();

    function loadCategories() {
        fetch(API.categories)
            .then(res => res.json())
            .then(data => {
                let html = "";
                data.forEach(cat => {
                    html += `
                        <div class="category-item">
                            <input type="checkbox" class="category-filter" value="${cat.id}">
                            <span class="category-label">${cat.title}</span>
                        </div>
                    `;
                });
                document.getElementById("categoryList").innerHTML = html;

                document.querySelectorAll(".category-filter").forEach(ch => {
                    ch.addEventListener("change", () => loadCourses(0));
                });
            });
    }

    function loadCourses(page = 0) {
        currentPage = page;

        const selected = [...document.querySelectorAll(".category-filter:checked")]
            .map(ch => "categoryIds=" + ch.value)
            .join("&");

        let url = API.courses + "?page=" + page;
        if (selected.length > 0) url += "&" + selected;

        const searchQuery = document.getElementById("searchInput").value.trim();
        if (searchQuery.length > 0) {
            url = API.search + "?query=" + encodeURIComponent(searchQuery) + "&page=" + page;
        }

        fetch(url)
            .then(res => res.json())
            .then(data => {
                const courses = Array.isArray(data) ? data : (data.content || []);
                renderCourses(courses);
                totalPages = data.totalPages || 1;
                renderPagination();
            });
    }

    function renderCourses(courses) {
        let html = "";
        courses.forEach(course => {
            html += `
                <div class="col-md-6 col-lg-4">
                    <div class="course-card">
                        <h5 style="color:#b28dff; font-size:22px;">${course.title}</h5>
                        <p>${course.description}</p>
                        <button class="btn btn-primary w-100 mt-2" onclick="openCourse(${course.id})">
                            –û—Ç–∫—Ä—ã—Ç—å –∫—É—Ä—Å
                        </button>
                    </div>
                </div>
            `;
        });
        document.getElementById("coursesContainer").innerHTML = html;
    }

    function openCourse(id) {
        window.location.href = "https://rdnmarkov.github.io/cources-webapp/course.html?id=" + id + "&chatId=" + chatId;
    }

    document.getElementById("searchButton").addEventListener("click", () => {
    loadCourses(0);
});

    function renderPagination() {
        const ul = document.getElementById("pagination");
        ul.innerHTML = "";

        if (totalPages <= 1) return;

        const createBtn = (page, text, disabled = false, active = false) => {
            const li = document.createElement("li");
            li.className = "page-item " + (disabled ? "disabled" : "") + (active ? " active" : "");
            li.innerHTML = `<a class="page-link" href="#">${text}</a>`;
            if (!disabled) {
                li.addEventListener("click", e => {
                    e.preventDefault();
                    loadCourses(page);
                });
            }
            return li;
        };

        ul.appendChild(createBtn(0, "¬´", currentPage === 0));
        ul.appendChild(createBtn(currentPage - 1, "‚Äπ", currentPage === 0));

        let start = Math.max(0, currentPage - 2);
        let end = Math.min(totalPages - 1, currentPage + 2);

        for (let i = start; i <= end; i++) {
            ul.appendChild(createBtn(i, i + 1, false, currentPage === i));
        }

        ul.appendChild(createBtn(currentPage + 1, "‚Ä∫", currentPage === totalPages - 1));
        ul.appendChild(createBtn(totalPages - 1, "¬ª", currentPage === totalPages - 1));
    }
</script>

</body>
</html>

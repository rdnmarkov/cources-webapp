<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Courses</title>

    <!-- Mobile first -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">

    <link href="css/index.css" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>

<body>

<!-- MOBILE HEADER -->
<div class="mobile-header">
    <button class="burger-btn" onclick="toggleSidebar()">‚ò∞</button>
    <span class="header-title">–ö–£–†–°–´</span>
</div>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
    <h5>–ö–ê–¢–ï–ì–û–†–ò–ò</h5>
    <div id="categoryList"></div>
</div>

<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

<!-- APP WRAPPER -->
<div class="app-wrapper">
    <div class="content">

        <h2 class="page-title">–ö–£–†–°–´. –í–∏—Å–∫–∏ —Å –∫–æ–¥–æ–º</h2>

        <div class="search-box">
            <input id="searchInput" type="text" placeholder="üîé –ü–æ–∏—Å–∫ –ø–æ –∫—É—Ä—Å–∞–º –∏ —É—Ä–æ–∫–∞–º...">
            <button id="searchButton">–ü–æ–∏—Å–∫</button>
        </div>

        <div id="coursesContainer" class="row g-3"></div>

        <ul id="pagination" class="pagination mt-3 justify-content-center"></ul>

    </div>
</div>

<script>
    /* Telegram */
    const tg = window.Telegram.WebApp;
    tg.expand();

    /* Params */
    const chatId = new URLSearchParams(window.location.search).get("chatId");

    /* API */
    const API = {
        categories: "/api/categories",
        courses: "/api/courses",
        search: "/api/search"
    };

    let currentPage = 0;
    let totalPages = 0;

    /* INIT */
    loadCategories();
    loadCourses();

    /* BURGER */
    function toggleSidebar() {
        sidebar.classList.toggle("open");
        sidebarOverlay.classList.toggle("show");
    }

    /* CATEGORIES */
    function loadCategories() {
        fetch(API.categories)
            .then(r => r.json())
            .then(data => {
                categoryList.innerHTML = data.map(cat => `
                    <label class="category-item">
                        <input type="checkbox" value="${cat.id}" class="category-filter">
                        <span>${cat.title}</span>
                    </label>
                `).join("");

                document.querySelectorAll(".category-filter").forEach(ch => {
                    ch.addEventListener("change", () => {
                        toggleSidebar();
                        loadCourses(0);
                    });
                });
            });
    }

    /* COURSES */
    function loadCourses(page = 0) {
        currentPage = page;

        const cats = [...document.querySelectorAll(".category-filter:checked")]
            .map(c => "categoryIds=" + c.value)
            .join("&");

        let url = `${API.courses}?page=${page}`;
        if (cats) url += "&" + cats;

        const q = searchInput.value.trim();
        if (q) url = `${API.search}?query=${encodeURIComponent(q)}&page=${page}`;

        fetch(url)
            .then(r => r.json())
            .then(data => {
                const courses = Array.isArray(data) ? data : data.content || [];
                renderCourses(courses);
                totalPages = data.totalPages || 1;
                renderPagination();
            });
    }

    function renderCourses(courses) {
        coursesContainer.innerHTML = courses.map(c => `
            <div class="col-12">
                <div class="course-card">
                    <h5>${c.title}</h5>
                    <p>${c.description || ""}</p>
                    <button onclick="openCourse(${c.id})">–û—Ç–∫—Ä—ã—Ç—å –∫—É—Ä—Å</button>
                </div>
            </div>
        `).join("");
    }

    function openCourse(id) {
        location.href = `/course.html?id=${id}&chatId=${chatId}`;
    }

    /* SEARCH */
    searchButton.onclick = () => loadCourses(0);

    /* PAGINATION */
    function renderPagination() {
        pagination.innerHTML = "";
        if (totalPages <= 1) return;

        for (let i = 0; i < totalPages; i++) {
            const li = document.createElement("li");
            li.className = "page-item " + (i === currentPage ? "active" : "");
            li.innerHTML = `<a class="page-link" href="#">${i + 1}</a>`;
            li.onclick = e => {
                e.preventDefault();
                loadCourses(i);
            };
            pagination.appendChild(li);
        }
    }
</script>

</body>
</html>
